<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration>

<configuration scan="true">

    <!-- === Configuración base === -->
    <conversionRule conversionWord="crlf" converterClass="jdk21.config.CRLFLogConverter" />
    <property name="CONSOLE_LOG_PATTERN"
              value="${CONSOLE_LOG_PATTERN:-%clr(%d{${LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd'T'HH:mm:ss.SSSXXX}}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %crlf(%m){red} %n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"/>

    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <include resource="org/springframework/boot/logging/logback/console-appender.xml" />

    <!-- === Configuración para Logstash === -->
    <springProperty scope="context" name="LOGSTASH_ENABLED" source="jhipster.logging.logstash.enabled" defaultValue="true"/>
    <springProperty scope="context" name="LOGSTASH_HOST" source="jhipster.logging.logstash.host" defaultValue="localhost"/>
    <springProperty scope="context" name="LOGSTASH_PORT" source="jhipster.logging.logstash.port" defaultValue="50000"/>

    <!-- Appender TCP para enviar los logs a Logstash -->
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
        <destination>${LOGSTASH_HOST}:${LOGSTASH_PORT}</destination>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder" />
    </appender>

    <!-- === Configuración de niveles de logging === -->
    <logger name="jdk21" level="INFO"/>
    <logger name="org.springframework" level="WARN"/>
    <logger name="org.hibernate" level="WARN"/>
    <logger name="liquibase" level="WARN"/>
    <logger name="org.springframework.security" level="WARN"/>
    <logger name="io.undertow" level="WARN"/>
    <logger name="io.swagger.v3" level="INFO"/>
    <!-- jhipster-needle-logback-add-log - JHipster will add a new log with level -->

    <!-- === Root logger: consola + Logstash === -->
    <springProperty name="log.level" source="logging.level.root" defaultValue="INFO"/>
    <root level="${log.level}">
        <appender-ref ref="CONSOLE" />
        <appender-ref ref="LOGSTASH" />
    </root>

    <!-- === Ajustes adicionales === -->
    <statusListener class="ch.qos.logback.core.status.NopStatusListener"/>
    <contextListener class="ch.qos.logback.classic.jul.LevelChangePropagator">
        <resetJUL>true</resetJUL>
    </contextListener>
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
    <!-- Dirección de tu contenedor Logstash -->
    <destination>localhost:50000</destination>

    <!-- Codificador para formato JSON -->
    <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
        <providers>
            <timestamp/>
            <pattern>
                <pattern>
                    {
                        "level": "%level",
                        "logger": "%logger",
                        "thread": "%thread",
                        "message": "%message",
                        "context": "%mdc"
                    }
                </pattern>
            </pattern>
        </providers>
    </encoder>
</appender>

<!-- Añadimos el appender LOGSTASH al root logger -->
<root level="INFO">
    <appender-ref ref="CONSOLE"/>
    <appender-ref ref="LOGSTASH"/>
</root>

</configuration>

